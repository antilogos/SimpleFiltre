<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
  <title>MODS DATA TO XLS CONVERTER</title>
	<link rel="shortcut icon" type="image/png" href="https://docs.google.com/drawings/d/e/2PACX-1vRmsUqz_w0baXylHjox1oadVVCB2B0kq8LtyvLEx9M7rZTjSr18UDf0IaDljbf5db3uUkd2Fi9MRwHX/pub?w=51&h=50"/>
	<style>
	</style>
  	<script>
		// Dictionary of mod tags with class item they apear on
			var dicoTag = new Map();
			dicoTag.set("claw", "Claw");
			dicoTag.set("axe", "One Hand Axe");
			dicoTag.set("mace", "One Hand Mace");
			dicoTag.set("sceptre", "Sceptre");
			dicoTag.set("rapier", "Thrusting One Hand Sword");
			dicoTag.set("wand", "Wand");
			dicoTag.set("weapon_can_roll_minion_modifiers", "Convoking Wand");
			dicoTag.set("sword", "One Hand Sword");
			dicoTag.set("dagger", "Rybe Dagger");
			dicoTag.set("attack_dagger", "Dagger");
			dicoTag.set("bow", "Bow");
			dicoTag.set("staff", "Staff");
			dicoTag.set("attack_staff", "Warstaff");
			dicoTag.set("axe","Two Hand Axe");
			dicoTag.set("mace", "Two Hand Mace");
			dicoTag.set("sword", "Two Hand Sword");
			dicoTag.set("amulet", "Amulet");
			dicoTag.set("belt", "Belt");
			dicoTag.set("ring", "Ring");
			dicoTag.set("unset_ring", "Unset Ring");
			dicoTag.set("gloves", "Gloves");
			dicoTag.set("boots", "Boots");
			dicoTag.set("helmet", "Helmet");
			// Try to regroup each mod tag with a basic category to look at
			var modGroup = new Map();
			// body_armour is str-dex-int chest, armour is common to all
			var itemBaseInfluence = ["sword", "2h_sword", "2h_axe", "axe", "claw", "dagger", "rune_dagger", "bow", "2h_mace", "staff", "warstaff", "mace", "sceptre", "wand", "helmet", "body_armour", "quiver", "gloves", "belt", "boots", "shield", "ring", "amulet"];
			var influenceType = ["_shaper", "_elder", "_basilisk", "_eyrie", "_adjudicator", "_crusader"];
			modGroup.set("Influences", itemBaseInfluence.map( base => influenceType.map( influence => base.concat(influence) )).reduce((a,b)=> a.concat(b), []));
			modGroup.set("One Handed Weapon", ["one_hand_weapon", "claw", "axe","mace", "sceptre", "rapier", "wand", "weapon_can_roll_minion_modifiers", "sword", "dagger", "attack_dagger", "weapon", "ranged", "dual_wielding_mod"]);
			modGroup.set("Two Handed Weapon", ["bow", "warstaff", "staff", "attack_staff", "axe","mace", "sword", "fishing_rod", "weapon", "ranged", "two_hand_weapon", "two_handed_mod"]);
			modGroup.set("Body Armour", ["default", "body_armour", "dex_armour", "dex_int_armour", "str_dex_armour", "str_dex_int_armour", "armour", "str_armour", "str_int_armour", "int_armour", "not_int", "not_str", "not_dex", "focus"]);
			modGroup.set("Boots", ["boots", "ward_armour"]);
			modGroup.set("Gloves", ["gloves", "ward_armour"]);
			modGroup.set("Helmet", ["helmet", "ward_armour"]);;
			modGroup.set("Accessories", ["ring","unset_ring", "belt", "amulet"]);
			modGroup.set("Offhand", ["quiver", "shield", "dex_int_shield", "str_dex_shield", "dex_shield", "str_shield", "str_int_shield", "shield_mod"]);
			modGroup.set("Jewel", ["jewel", "abyss_jewel_melee","abyss_jewel_ranged","abyss_jewel_caster","abyss_jewel_summoner","abyss_jewel", "expansion_jewel_large", "expansion_jewel_medium", "expansion_jewel_small"]);
			modGroup.set("Flask", ["utility_flask", "critical_utility_flask", "life_flask", "no_effect_flask_mod", "flask", "expedition_flask"]);
			modGroup.set("Map", ["map", "low_tier_map", "mid_tier_map", "top_tier_map", "maven_map", "primordial_map", "maven_void_map_feared", "maven_void_map", "secret_area"]);
			modGroup.set("Logbook", ["expedition_logbook", "expedition_faction_black_scythe", "expedition_faction_order_of_the_chalice", "expedition_faction_knights_of_the_sun", "expedition_faction_druids_of_the_broken_circle"]);
			modGroup.set("Large Cluster Jewel", ["affliction_axe_and_sword_damage", "affliction_mace_and_staff_damage", "affliction_dagger_and_claw_damage", "affliction_bow_damage", "affliction_wand_damage", "affliction_damage_with_two_handed_melee_weapons", "affliction_attack_damage_while_dual_wielding_", "affliction_attack_damage_while_holding_a_shield", "affliction_attack_damage_", "affliction_brand_damage", "affliction_spell_damage", "affliction_chaos_damage", "affliction_cold_damage", "affliction_elemental_damage", "affliction_fire_damage", "affliction_lightning_damage", "affliction_minion_damage", "affliction_physical_damage"]);
			modGroup.set("Medium Cluster Jewel", ["affliction_area_damage", "affliction_critical_chance", "affliction_fire_damage_over_time_multiplier", "affliction_chaos_damage_over_time_multiplier", "affliction_physical_damage_over_time_multiplier", "affliction_cold_damage_over_time_multiplier", "affliction_damage_over_time_multiplier", "affliction_effect_of_non-damaging_ailments", "affliction_projectile_damage", "affliction_totem_damage", "affliction_trap_and_mine_damage", "affliction_warcry_buff_effect", "affliction_channelling_skill_damage", "affliction_life_and_mana_recovery_from_flasks", "affliction_flask_duration", "affliction_damage_while_you_have_a_herald", "affliction_minion_damage_while_you_have_a_herald", "affliction_minion_life", "old_do_not_use_affliction_aura_effect", "old_do_not_use_affliction_curse_effect"]);
			modGroup.set("Small Cluster Jewel", ["affliction_maximum_life", "affliction_chance_to_dodge_attacks", "affliction_cold_resistance", "affliction_chaos_resistance", "affliction_armour", "affliction_evasion", "affliction_fire_resistance", "affliction_maximum_mana", "affliction_curse_effect_small", "affliction_maximum_energy_shield", "affliction_lightning_resistance", "affliction_chance_to_block", "affliction_reservation_efficiency_small"]);
			var currCat = Array.from(modGroup.values()).reduce((a,b)=> a.concat(b), []);

			// Load all mods from repoe file
	var allMods, itemType, loadMod;
	fetch("https://raw.githubusercontent.com/brather1ng/RePoE/master/RePoE/data/mods.json").then(response => response.json()).then(parsed => {
		allMods = parsed;
    console.log("domain list:", new Set(Object.entries(allMods).map(m => m[1].domain)));
    console.log("generation_type list:", new Set(Object.entries(allMods).map(m => m[1].generation_type)));
    // fetching the list of item type for spawning mods (spawn_weights.tag)
    itemType = new Set(Object.entries(allMods).flatMap(m => Object.entries(m[1].spawn_weights).filter(s => s[1].weight > 0).map(s => s[1].tag)));
    console.log("item type spawn list:", itemType);
		loadMod = true;
		if(currCat.filter(i => !Array.from(itemType).includes(i)).length > 1) {
			console.log("outdated mods: ", currCat.filter(i => !Array.from(itemType).includes(i)));
		}
    init();
	});
		// Load all base item class from repoe file
  var classItems, baseItems, itemTag, loadItem;
  fetch("https://raw.githubusercontent.com/brather1ng/RePoE/master/RePoE/data/base_items.json").then(response => response.json()).then(parsed => {
		baseItems = parsed;
		classItems = new Set(Object.entries(baseItems).map(m => m[1].item_class));
    console.log("class list missing:", Object.entries(classItems).filter(c => !catByClass.has(c)));
    itemTag = new Set(Object.entries(baseItems).flatMap(m => m[1].tags));
    console.log("item tag list:", itemTag);
		loadItem = true;
		init();
	});
	const urlParams = new URLSearchParams(window.location.search);

  var allPrefix, allSuffix, tagsCommon, tagsUnlink;
	// tag common
	var catJewel = catByClass["Jewel"];
	var catWeapon = catByClass["One Handed Weapon"];;
	var catJewellery = catByClass["Accessories"];
	var catArmour = catByClass["Body Armour"];
	var catStrange = ["default", "not_dex", "not_int", "not_str", "focus", "cannot_be_twinned"];
	var catFragment = ["map", "old_map", "low_tier_map", "mid_tier_map", "top_tier_map", "watchstone_item", "watchstone_environment", "watchstone_league"]
	//	tag in item not in type: "not_for_sale", "atlas_base_type", "amuletatlas1", "amuletatlas2", "amuletatlas3", "demigods", "talisman", "bootsatlas1", "bootsatlas2", "bootsatlas3", "bootsatlasdexint", "glovesatlasdex", "glovesatlasint", "glovesatlasstr", "glovesatlasstrint", "helmetatlas1", "currency", "watchstone", "beltatlas1", "beltatlas2", "bestiary_net", "high_level_map", "sextant", "currency_shard", "affliction_orb", "quality_currency", "breachstone_splinter", "breach_blessing", "essence", "catalyst", "legion_splinter", "harbinger_orb_shard", "mushrune", "weapon_divination", "divination_card", "jewellery_divination", "shaper_divination", "armour_divination", "elder_divination", "gem", "up_to_level_8_gem", "up_to_level_2_gem", "level_capped_gem", "vaal_gem", "support_gem", "heist_coin", "dexjewel", "intjewel", "strjewel", "affliction_splinter", "breachstone", "breachstone2", "breachstone3", "breachstone4", "atziri1", "atziri2", "indoors_area", "dungeon", "mountain", "urban", "cave", "temple", "swamp", "forest", "beach", "shaped_map", "can_be_infected_map", "quiveratlas1", "twostonering", "ringatlas1", "ringatlas2", "ringatlas3", "ringatlas4", "ringatlas5", "rusted_scarab", "polished_scarab", "gilded_scarab", "jewelled_scarab", "onehand", "maraketh", "wandatlas1", "twohand", "small_staff", "warstaff"

	function init() {
		if(loadMod && loadItem) {
	    // all item mods
	    allPrefix = Object.values(allMods).filter(m => m.domain == "item" && m.generation_type == "prefix");
	    allSuffix = Object.values(allMods).filter(m => m.domain == "item" && m.generation_type == "prefix");
	    // tags
			tagsCommon = Array.from(itemType).filter(o => Array.from(itemTag).includes(o));
			tagsUnlink = Array.from(itemType).filter(o => !Array.from(itemTag).includes(o));
			Object.values(allMods).filter(m => m.spawn_weights.filter(s => s.weight > 0).map(s => s.tag).includes(tagsUnlink[1]))
			// after loading, display all item class
			displayModsGroup();
		}
	};

	function listAffixFromCat(cat) {
		return Object.values(allMods).filter(m => m.domain == "item" && Object.entries(m.spawn_weights).filter(s => s[1].tag === cat).length > 0);
	};

// Display
	function displayModsGroup() {
		let classdiv = document.getElementById("classdiv");
		while(classdiv.firstChild) classdiv.removeChild(classdiv.firstChild);
		modGroup.forEach( (value, key, map) => {
			let button = document.createElement("button");
			button.innerHTML = key;
			button.onclick = function() { displayCatListForGroup(value) };
			classdiv.appendChild(button);
		});
	};

	function displayItemClass() {
		/* Not used anymore
		let classdiv = document.getElementById("classdiv");
		while(classdiv.firstChild) classdiv.removeChild(classdiv.firstChild);
		Array.from(classItems).filter(c => catByClass.get(c) && catByClass.get(c).length > 0).map( i => {
			let button = document.createElement("button");
			button.innerHTML = i;
			button.onclick = function() { displayCatListForClass(i) };
			classdiv.appendChild(button);
		});
		*/
	};

	function displayCatListForGroup(groupMod) {
		let catdiv = document.getElementById("catdiv");
		while(catdiv.firstChild) catdiv.removeChild(catdiv.firstChild);
		Array.from(groupMod).filter(c => listAffixFromCat(c).length > 0).map( i => {
			let button = document.createElement("button");
			button.innerHTML = i;
			button.onclick = function() { displayAffixForCat(i) };
			catdiv.appendChild(button);
		});
	};

	function displayCatListForClass(itemClass) {
		/* Not used anymore
		let catdiv = document.getElementById("catdiv");
		while(catdiv.firstChild) catdiv.removeChild(catdiv.firstChild);
		Array.from(catByClass.get(itemClass)).filter(c => listAffixFromCat(c).length > 0).map( i => {
			let button = document.createElement("button");
			button.innerHTML = i;
			button.onclick = function() { displayAffixForCat(i) };
			catdiv.appendChild(button);
		});
		*/
	};

	function cascadeDisplay(elem, display) {
		if(elem.firstChild) {
			if(display == "table") {
				cascadeDisplay(elem.firstChild, "table-row");
			} else if("table-row") {
				cascadeDisplay(elem.firstChild, "table-cell");
			}
		}
		if((display == "table-row" || display == "none") && elem.nextSibling) {
			cascadeDisplay(elem.nextSibling, display);
		}
		if(elem.style && elem.style.display) {
			elem.style.display = display;
		}
	}

	function displayAffixForCat(category) {
		let affixdiv = document.getElementById("affixdiv");
		while(affixdiv.firstChild) affixdiv.removeChild(affixdiv.firstChild);
		// separate by generation_type
		let listAffix = listAffixFromCat(category);
		let generationType = new Set(listAffix.map(a => a.generation_type));
		Array.from(generationType).map( i => {
			let generationdiv = document.createElement("div");
			generationdiv.style = "display: table; width: 100%;";
			let generationdivcaption = document.createElement("div");
			generationdivcaption.onclick = function(e) {
				var next = e.target.nextSibling;
				if(next && next.style.display == "none") {
					cascadeDisplay(next, "table-row");
				} else if(next && next.style.display == "table-row") {
					cascadeDisplay(next, "none");
				}
			 };
			generationdivcaption.style = "display: table-caption; font-weight: bold;";
			generationdiv.appendChild(generationdivcaption);
			// regroup by type
			let listTypeOfType = listAffix.filter(a => a.generation_type == i);
			let affixType = new Set(listTypeOfType.map(a => a.type));
			Array.from(affixType).map( j => {
				let statList = Array.from(listTypeOfType).filter(a => a.type == j);
				let rowdiv = document.createElement("div");
				rowdiv.style = "display: none;";
				generationdiv.appendChild(rowdiv);
				let typediv = document.createElement("div");
				typediv.style = "display: none;";
				typediv.innerHTML = j + " ("+statList.length+")";
				typediv.onclick = function(e) {
					var next = e.target.nextSibling;
					if(next && next.style.display == "none") {
						cascadeDisplay(next, "table-cell");
					} else if(next && next.style.display == "table-cell") {
						cascadeDisplay(next, "none");
					}
				}
				rowdiv.appendChild(typediv);
				let statdiv = document.createElement("div");
				statdiv.style = "display: none;";
				statdiv.innerHTML = statList.flatMap(a => a.stats).map(s => s.id + ": " + s.min + "-" + s.max).join("<br />");
				rowdiv.appendChild(statdiv);
			});
			generationdivcaption.innerHTML = i + "("+Array.from(affixType).length+")";
			affixdiv.appendChild(generationdiv);
		});
	};
	</script>
</head>
	<body height="100vh">
		<div id="maindiv" height="100vh">
		</div>
		<div id="classdiv" height="100vh">
		</div>
		<div id="catdiv" height="100vh">
		</div>
		<div id="affixdiv" height="100vh">
		</div>
	</body>
</html>
